desc: "Raspberry 5 with xen dom0less"
min_ver: "0.24"

variables:
  # Common build configuration
  YOCTOS_WORK_DIR: "yocto"
  DOM0_OS: "zephyr"

  # Raspberry 5 build configuration

  ZEPHYR_DOM0_DIR: "zephyr"
  ZEPHYR_DOM0_MACHINE: "rpi_5"
  ZEPHYR_DOM0_TARGET: "zephyr-dom0-xt"
  ZEPHYR_DOM0_BUILD_DIR: "build-dom0"

  ZEPHYR_DOMU1_DIR: "zephyr_sync"
  ZEPHYR_DOMU1_BUILD_DIR: "build-sync"

  ZEPHYR_DOMU2_DIR: "zephyr_blinky"
  ZEPHYR_DOMU2_BUILD_DIR: "build-blinky"

  DOMD_BUILD_DIR: "build-domd"
  DOMU_BUILD_DIR: "build-domu"
  XT_XEN_DTBO_NAME: "%{SOC_FAMILY}-%{MACHINE}-xen.dtbo"
  XT_DOMD_DTB_NAME: "%{SOC_FAMILY}-%{MACHINE}-domd.dtb"
  XEN_DT_SCMI_NAME: "%{SOC_FAMILY}-%{MACHINE}-xen-scmi"

  XT_DOMD_IMAGE: "rpi5-image-xt-domd"
  XT_DOMU_IMAGE: "core-image-thin-initramfs"

  DOMU_MACHINE: "generic-armv8-xt"

common_data:
  common_yocto_sources: &COMMON_YOCTO_SOURCES
    - type: git
      url: "https://git.yoctoproject.org/poky"
      rev: "7bb9c2255b3aed8441fba1133f350b223a3b6379"
    - type: git
      url: "https://git.openembedded.org/meta-openembedded"
      rev: "727811eaf256b88fd135be99559f2cbf14c82fce"
    - type: git
      url: "https://github.com/xen-troops/meta-xt-common.git"
      rev: "3f17cfe7a64491ff854a34aa76a90b3235723bc1"
    - type: git
      url: "https://git.yoctoproject.org/meta-virtualization"
      rev: "9e040ee8dd6025558ea60ac9db60c41bfeddf221"
    - type: git
      url: "https://git.yoctoproject.org/meta-selinux"
      rev: "c4b059262089b74c8fbf8dd5fdf5fd7bc1deeddc"

  common_yocto_layers: &COMMON_YOCTO_LAYERS
    - "../meta-openembedded/meta-oe"
    - "../meta-openembedded/meta-python"
    - "../meta-openembedded/meta-networking"
    - "../meta-openembedded/meta-filesystems"
    - "../meta-xt-common/meta-xt-domx"
    - "../meta-selinux"
    - "../meta-virtualization"

  # Conf options for domain that use linux
  linux_domain_conf: &LINUX_DOMAIN_CONF
    - [SSTATE_DIR, "${TOPDIR}/../common_data/sstate"]
    - [DL_DIR, "${TOPDIR}/../common_data/downloads"]
    # Skip warning about missing "virtualization" distro feature
    - [SKIP_META_VIRT_SANITY_CHECK, "1"]
    # Init manager
    - [INIT_MANAGER, "systemd"]
    # Do not install kernel image to rootfs to decrease initrd size
    - ["RDEPENDS_${KERNEL_PACKAGE_NAME}-base", ""]
    # Remove features that we are not used
    - [DISTRO_FEATURES:remove,
        "x11 gtk gobject-introspection-data nfc irda zeroconf 3g sysvinit
         acl alsa argp pcmcia usbgadget opengl ptest multiarch wayland
         vulkan sysvinit"]

components:
  dom0:
    default: true
    build-dir: "%{ZEPHYR_DOM0_DIR}"
    sources:
      - type: west
        url: "https://github.com/xen-troops/zephyr-dom0-xt.git"
        rev: "rpi5_dom0_dev"
    builder:
      type: zephyr
      board: "%{ZEPHYR_DOM0_MACHINE}"
      target: "%{ZEPHYR_DOM0_TARGET}"
      work_dir: "%{ZEPHYR_DOM0_BUILD_DIR}"
      vars:
        - "CONFIG_DOM_STORAGE_FATFS_LOGICAL_DRIVE_NAME=\"1\""
      target_images:
        - "%{ZEPHYR_DOM0_BUILD_DIR}/zephyr/zephyr.bin"

  domu_sync:
    default: true
    build-dir: "%{ZEPHYR_DOMU1_DIR}"
    sources:
      - type: west
        url: "https://github.com/xen-troops/zephyr.git"
        rev: "zephyr-v3.6.0-xt"
    builder:
      type: zephyr
      board: xenvm
      target: zephyr/samples/synchronization
      work_dir: "%{ZEPHYR_DOMU1_BUILD_DIR}"
      target_images:
        - "%{ZEPHYR_DOMU1_BUILD_DIR}/zephyr/zephyr.bin"

  domu_blinky:
    default: true
    build-dir: "%{ZEPHYR_DOMU2_DIR}"
    sources:
      - type: west
        url: "https://github.com/xen-troops/zephyr.git"
        rev: "zephyr-v3.6.0-xt"
    builder:
      type: zephyr
      board: xenvm
      target: zephyr/samples/basic/blinky
      work_dir: "%{ZEPHYR_DOMU2_BUILD_DIR}"
      snippets:
        - "rpi_5_xen_domd"
      target_images:
        - "%{ZEPHYR_DOMU2_BUILD_DIR}/zephyr/zephyr.bin"

  domu_unikraft:
    default: true
    build-dir: domu_unikraft
    sources:
      - type: http
        url: https://github.com/aoscloud/demo-services/raw/main/monkey_zephyr/src/helloworld_xen-arm64
        file: helloworld_xen-arm64
        dir: "."
    builder:
      type: "null"

parameters:
  # Machines
  MACHINE:
    desc: "Raspberry Pi machines"
    rpi5:
      default: true
      overrides:
        variables:
          MACHINE: "raspberrypi5"
          SOC_FAMILY: "bcm2712"
